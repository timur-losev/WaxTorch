# Swift <-> C++ Parity Tests

`mv2s_fixture_parity_test.cpp` validates every `.mv2s` fixture under `fixtures/parity/` using:
- `WaxStore::Open(...)`
- `WaxStore::Verify(true)`

`mv2s_fixture_generator.cpp` creates a deterministic synthetic fixture pack under
`fixtures/parity/synthetic/` (small WAL layout for repository-friendly fixture sizes).

Optional sidecar expectations are supported per fixture:
- `<name>.mv2s.expected`

Sidecar format:
```text
# comments allowed
mode=pass            # pass | open_fail | verify_fail
verify_deep=true     # bool, default true
frame_count=0
generation=7
error_contains=checksum mismatch
```

Notes:
- `frame_count` / `generation` are valid only with `mode=pass`.
- `error_contains` is optional and applies to failure modes.

CI hard mode:
- set `-DWAXCPP_REQUIRE_PARITY_FIXTURES=ON` to fail when no fixtures are present.
- set `-DWAXCPP_REQUIRE_SWIFT_FIXTURES=ON` to fail when only `synthetic/` fixtures are present.
  This is the recommended gate for closing M2 with cross-language artifacts.

Fixture generation:
```bash
cmake --build cpp/build --target waxcpp_mv2s_fixture_generator
./cpp/build/Debug/waxcpp_mv2s_fixture_generator
```

Generator logging:
```bash
# powershell
$env:WAXCPP_TEST_LOG='1'; ./cpp/build/Debug/waxcpp_mv2s_fixture_generator
```

Expected fixture layout for cross-language parity:
- `fixtures/parity/synthetic/*.mv2s`: C++ deterministic synthetic fixtures.
- `fixtures/parity/swift/*.mv2s`: fixtures generated by Swift Wax implementation.

Swift fixture generation command (macOS + Swift toolchain):
```bash
swift run WaxParityFixtureGenerator --output fixtures/parity/swift
```

No local macOS option:
1. Trigger GitHub Actions workflow `Swift Parity Fixtures`.
2. Download generated artifact.
3. Place contents into `fixtures/parity/swift/`.
4. Re-run parity with strict gate:
```bash
cmake -S cpp -B cpp/build -DWAXCPP_REQUIRE_PARITY_FIXTURES=ON -DWAXCPP_REQUIRE_SWIFT_FIXTURES=ON
cmake --build cpp/build --config Debug
ctest --test-dir cpp/build -C Debug --output-on-failure -R waxcpp_mv2s_parity_test
```
